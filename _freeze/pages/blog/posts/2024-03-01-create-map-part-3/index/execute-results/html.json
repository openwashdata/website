{
  "hash": "2a0f317d583de79103734da3d373a15c",
  "result": {
    "markdown": "---\ntitle: Creating and visualizing maps of WASH data - Part 3\nsubtitle: Where are the pumps, waste skips, and humanitarian organizations?\ndescription: In this series of blog posts, you will learn how to create maps with your geospatial data or plot a map with the help of external geospatial data.\ncategories:\n  - r-tutorial\nauthor: \n  - name: \"Mian Zhong\"\n    affiliation: Global Health Engineering, ETH Zurich\n    affiliation_url: https://ghe.ethz.ch/\n    orcid_id: 0009-0009-4546-7214\ndate: \"2024-08-12\"\ndraft: true\n#image: \"thumbnail.jpg\"\n#image-alt: \"Open data in water sanitation in minimal style created by stable diffusion model.\"\n---\n\n\n\n# Review\nWelcome to the final post in our series on creating and visualizing WASH data maps. In this post, we'll focus on crafting an interactive map that enhances user experience and data exploration. If you missed the previous posts or need a refresher, you can revisit them here:\n\n- [Part 1: Plot map with collected data](https://openwashdata.org/pages/blog/posts/2024-03-01-create-map-part-1/)\n- [Part 2: Plot map with external geodata](https://openwashdata.org/pages/blog/posts/2024-03-01-create-map-part-2/)\n\n\n# Introduction\n\n## Why an interactive map?\nInteractive maps allow users to explore data more deeply by offering the ability to zoom in and out for different perspectives. They also make it easy to analyze various groups within the map, such as showing or hiding specific layers (e.g., water pumps of different types) to focus on particular variables. Additionally, interactive maps can include detailed regional information—like GDP or population—which can be revealed through hover effects, enriching the overall understanding of the data.\n\n\n## Useful R libraries\nIn the previous post, we explored some useful R libraries such as `sf` and `tmap`.\nWe will explore more with `tmap` again, and we introduce a commonly used library for plotting interactive maps, `leaflet`.\n\n- `leaflet`: an open-source JavaScript library for interactive maps.\n\n## Useful openwashdata datasets \nMany openwashdata datasets use interactive maps in their demos. Here we will showcase the following data packages:\n\n- [`cbssuitabilityhaiti`](https://github.com/openwashdata/cbssuitabilityhaiti): Spatial data to support an analysis of suitability of container-based sanitation in flood prone areas of Haiti.\n- [`waterpumpkwale`](https://github.com/openwashdata/waterpumpkwale): Weekly volume of water pumped for handpumps monitored with Smart Handpump technology, Kwale County, Kenya\n\n\n# Plot interactive maps\n## Installing and Loading Required Packages\nBefore we dive in, ensure you have the necessary packages installed and loaded:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tmap)\nlibrary(leaflet)\nlibrary(dplyr)\nlibrary(sf)\n# Install openwashdata packages by uncommenting the following lines\n# install.packages(\"devtools\")\n# devtools::install_github(\"openwashdata/cbssuitabilityhaiti\")\n# devtools::install_github(\"openwashdata/waterpumpkwale\")\nlibrary(cbssuitabilityhaiti)\nlibrary(waterpumpkwale)\n```\n:::\n\n\n## Plotting maps with `tmap` library\nIn this section, we'll learn how to create interactive maps using the `tmap` library in R. To do this, we'll work with a data package called `cbssuitabilityhaiti`, which includes two datasets: `mwater` and `okap`.\n\n- The `mwater` dataset contains information about different types of water access points in Haiti, such as boreholes and protected springs.\n- The `okap` dataset provides information on population density, socioeconomic status, suitability for pit latrines, and areas where sewage construction is prioritized. \n\nTo understand the context, Haiti is a island state in the Caribbean sea. It has four administrative levels where the 3rd level is used for this tutorial. The 3rd administrative level contains 134 areas. Our focus region is the extended area around Cap Haïtien and l'Acul-du-Nord.\n\nWe'll use the tmap library in R to visualize maps showing water access points and their distribution across regions with different socioeconomic statuses.\n\n### Step 1: Downloading and Unzipping External Data\nFirst, we need to obtain spatial data that outlines the boundaries of Haiti's 3rd administrative level areas. We'll download this data from the Stanford database and unzip it to use in our analysis. The following code will download the files to your current working directory.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Download the zip file containing Haiti ADM3 spatial data\nutils::download.file(url = \"https://stacks.stanford.edu/file/druid:kz179wf4778/data.zip?download=true\", destfile = \"3rd-level-haiti-divisions.zip\", mode = \"wb\")\n\n# Unzip the downloaded file into current working directory\nunzip(\"3rd-level-haiti-divisions.zip\", exdir = \"haiti-adm3\")\n\n# Optionally, remove the zip file to clean up your workspace\nfile.remove(\"3rd-level-haiti-divisions.zip\")\n```\n:::\n\n\n### Step 2: Reading the Spatial Data\nOnce the data is unzipped, we need to read the spatial files into R so we can work with them. We'll use the `sf` package, which is great for handling spatial (geographic) data in R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read the shapefile of Haiti's ADM3 into an sf object\nhaiti_adm3 <- \n    st_read(\"haiti-adm3/HTI_adm3.shp\") |>\n    st_as_sf()\n# Set tmap to interactive view mode\ntmap_mode(\"view\")\n```\n:::\n\n\nWe are particularly interested in the northern part of Haiti, focusing on the regions around Cap-Haïtien and l'Acul-du-Nord. These regions correspond to `ID_2 = 24` and `ID_2 = 25` in the `haiti_adm3` dataset.\n\nThe code below creates an interactive map where:\n\n- All regions are shown in orange.\n- Cap-Haïtien and l'Acul-du-Nord are highlighted in yellow.\n\nYou can explore the map interactively, clicking on regions to see more information.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Select Cap Haïtien and l'Acul-du-Nord\ncaphaitien <- filter(haiti_adm3, (ID_2 == 24 | ID_2 == 25) & ID_3 != 76 & ID_3 != 80)\n\nhaiti_adm3 |> \n  tm_shape() +\n  tmap_options(check.and.fix = TRUE) +\n  tm_borders() +\n  tm_fill(col = \"orange\", alpha = 0.6) +\n  tm_shape(caphaitien) + \n  tm_borders() +\n  tm_fill(col = \"yellow\", alpha = 0.6)\n```\n:::\n\n\nNotice that you can use your mouse to click on each region and read more information from the dataset `haiti_adm3`. \n\n### Step 3: Prepare Data for Visualization\nNow we have three data sources: `haiti_adm3` (spatial data about Haiti), `mwater`(water access points), and `okap`(socioeconomic stauts). We filter each dataset to focus on the areas we are interested in.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# filter Cap-Haitien adm3 map data\ncap_adm3 <- haiti_adm3 |>\n  filter(ID_3 == 77|ID_3 == 78 | ID_3 == 79 | ID_3 == 81) # select North\n\n# filter Cap-Haitien mwater data\ncap_mwater <- mwater |>\n  filter(str_detect(administra, \"Cap Haitien\"))\n\n# filter Cap-Haitien okap data\ncap_okap <- okap |>\n  filter(cte == \"ctecaphaitien\")\n```\n:::\n\n\n### Step 4: Plot and Visualize Map \nFinally, we use `tmap` to plot and visualize the data on an interactive map. This code creates a multi-layered map:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncap_adm3 |>\n  tm_shape() + # Sets up the map's base layer using the northern region's boundaries.\n  tm_borders(lwd = 2) +\n  tm_layout(bg.color = \"lightblue\") +\n  tm_shape(cap_okap) + # Adds a layer representing the socioeconomic data.\n  tm_borders() +\n  tm_fill(col = \"economy\", palette = \"YlOrBr\") + #  Fills regions based on their economic status\n  tm_shape(cap_mwater) +\n  tm_dots(col = \"type\", palette = \"Blues\") # Plots water access points as dots and colored based on the type of water source\n```\n:::\n\n\nThis map visually displays the distribution of water access points and their relationship with socioeconomic conditions in the Cap-Haïtien region.\n\n## Plotting maps with `leaflet` library\nIn this section, we will use the `waterpumpkwale` data package, which contains three datasets: `location`, `weeklyvol2014`, and `weeklyvol2015`. The `location` dataset provides the latitude and longitude of the pumps, stored in the `lat_wgs84` and `long_wgs84` columns, respectively. Using this information, we can create an interactive map to visualize the locations of these hand pumps. \n\nLet's walk through the steps to achieve this.\n\nFirst, we observe the `pumpid` column of the `location` dataset.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Uncomment the following line to observe the whole column\n# waterpumpkwale::location$pumpid\n\n# For readability, we'll display out the first and last entries \nhead(waterpumpkwale::location$pumpid)\ntail(waterpumpkwale::location$pumpid)\n```\n:::\n\nNotice that each pumpid starts with a letter from “A”, “B”, “C”, “D”, or “E”, which may indicate the group to which the pumps belong. Based on this, we can later enable group options in leaflet to allow users to select which group of pumps to display.\n\n### Step 1: Plotting Hand Pumps from a Single Group\nTo begin, we will filter the location dataset to include only the pumps with IDs starting with the letter \"A\". We’ll then plot these pumps on a map using the leaflet library.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(waterpumpkwale)\n\n# Select pumps with IDs starting with \"A\"\ngroup_A <- waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"A\"))\n\n# Plot Group A pumps on the map\nleaflet(options = leafletOptions(crs = leafletCRS(proj4def = \"WGS84\"))) %>% # declare coordinate system\n  addProviderTiles(\"OpenStreetMap\") %>% # provide the base layer of the country map\n  addMarkers(\n    data = group_A,\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`)\n```\n:::\n\n\n\n### Step 2:  Plotting Hand Pumps from All Groups\n\nTo display pumps from all groups on the map, we can specify the group parameter in the addMarkers() function. This allows users to view pumps from different groups and choose which ones to display.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot an interactive map with group option\nhandpumpmap <- leaflet(options = leafletOptions(crs = leafletCRS(proj4def = \"WGS84\"))) %>% # declare coordinate system\n  addProviderTiles(\"OpenStreetMap\") %>%\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"A\")), # select pump id that starts with a particular string pattern\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    group = \"Pump ID: A\"\n  ) |>\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"B\")),\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    group = \"Pump ID: B\"\n  ) |>\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"C\")),\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    group = \"Pump ID: C\"\n  ) |>\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"D\")),\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    group = \"Pump ID: D\"\n  ) |>\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"E\")),\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    group = \"Pump ID: E\"\n  ) |>\n  # Layers control\n  addLayersControl(\n    overlayGroups  = c(\"Pump ID: A\", \"Pump ID: B\", \"Pump ID: C\", \"Pump ID: D\", \"Pump ID: E\"),\n    options = layersControlOptions(collapsed = FALSE)\n  )\n\nhandpumpmap\n```\n:::\n\n\n### Step 3: Customize the Map\nNow we want to add more flavors to the map. Here are some options to enrich the map:\n\n- customize the marker icon\n- add mouse hover effects\n- add mouse click-icon effects\n\nIn some cases, the default markers may not be the best representation for your data. You can customize marker icons using the `makeIcon()` function from the `leaflet` package. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# customize marker icon \nhandpumpicon <- makeIcon(\n  iconUrl = \"https://cdn-icons-png.flaticon.com/512/5984/5984318.png\",\n  iconWidth = 30, iconHeight = 30\n)\n\n# plot an interactive map with group option\nhandpumpmap <- leaflet(options = leafletOptions(crs = leafletCRS(proj4def = \"WGS84\"))) %>% # declare coordinate system\n  addProviderTiles(\"OpenStreetMap\") %>%\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"A\")), # select pump id that starts with a particular string pattern\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    popup = ~pumpid,\n    label = ~description,\n    icon = handpumpicon,\n    group = \"Pump ID: A\"\n  ) |>\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"B\")),\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    popup = ~pumpid,\n    label = ~description,\n    icon = handpumpicon,\n    group = \"Pump ID: B\"\n  ) |>\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"C\")),\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    popup = ~pumpid,\n    label = ~description,\n    icon = handpumpicon,\n    group = \"Pump ID: C\"\n  ) |>\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"D\")),\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    popup = ~pumpid,\n    label = ~description,\n    icon = handpumpicon,\n    group = \"Pump ID: D\"\n  ) |>\n  addMarkers(\n    data = waterpumpkwale::location |> dplyr::filter(startsWith(pumpid, \"E\")),\n    lng = ~`long_wgs84`,\n    lat = ~`lat_wgs84`,\n    popup = ~pumpid,\n    label = ~description,\n    icon = handpumpicon,\n    group = \"Pump ID: E\"\n  ) |>\n  # Layers control\n  addLayersControl(\n    overlayGroups  = c(\"Pump ID: A\", \"Pump ID: B\", \"Pump ID: C\", \"Pump ID: D\", \"Pump ID: E\"),\n    options = layersControlOptions(collapsed = FALSE)\n  )\n\nhandpumpmap\n```\n:::\n\n\n# Conclusion\nIn this tutorial, we explored how to create interactive maps in R using the `tmap` and `leaflet` libraries. We worked with datasets from the `cbssuitabilityhaiti` and `waterpumpkwale` packages, focusing on visualizing water access points data in Haiti and hand pump locations in Kenya.\n\nWe've covered how to:\n\n- Explored visualizing water access points and socioeconomic data for regions in Haiti using tmap.\n- Created customizable and dynamic maps of hand pump locations in Kenya with leaflet.\n- Practiced layering different data sources and adding interactivity to enhance map visualization.\n\nThis series of creating maps should give you the tools to start creating your own insightful maps. As you become more comfortable with R, you can explore more advanced features such as adding polygons, customizing popups with HTML, and integrating other data sources. Happy mapping!\n\nReferences:\n\n1. [Example of using the package `cbssuitabilityhaiti`](https://openwashdata.github.io/cbssuitabilityhaiti/articles/examples.html)\n2. [Example: track pump location and volume change](https://openwashdata.github.io/waterpumpkwale/articles/examples.html)",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}