{
  "hash": "6b58818324d68871f49b069b7f333ebe",
  "result": {
    "markdown": "---\ntitle: Creating and visualizing maps of WASH data - Part 2\nsubtitle: Where are the pumps, waste skips, and humanitarian organizations?\ndescription: In this series of blog posts, you will learn how to create maps with your geospatial data or plot a map with the help of external geospatial data.\ncategories: \n  - r-tutorial\nauthor: \n  - name: \"Mian Zhong\"\n    affiliation: Global Health Engineering, ETH Zurich\n    affiliation_url: https://ghe.ethz.ch/\n    orcid_id: 0009-0009-4546-7214\ndate: \"2024-05-02\"\ndraft: false\nimage: \"thumbnail.jpg\"\nimage-alt: \"Global map of humanitarian headquarter concentration.\"\n---\n\n\n\n\n# Introduction\n\nIn the [previous post](https://openwashdata.org/pages/blog/posts/2024-03-01-create-map-part-1/), we start to plot maps with the collected data. However, we may only collect location data points or variables based on implicit geodata (e.g. countries). Therefore, we need external geodata like country boundaries as the base layers for our maps. In this blog post, we will dive into plotting maps with external geodata. We combine such external geodata with the dataset from an openwashdata package, and plot a thematic map.\n\n## Thematic map: what and why?\n\nWhat is a thematic map? According to Wikipedia, we can think of thematic map as\n\n> A thematic map is a type of map that portrays the geographic pattern of a particular subject matter in a geographic area. This usually involves the use of map symbols to visualize selected properties of geographic features that are not naturally visible, such as temperature, language, or population. [^1]\n\n[^1]: [Wikipedia: Thematic map](https://en.wikipedia.org/wiki/Thematic_map)\n\n## Useful R libraries:\n\n-   `rnaturalearth`: An R package to hold and facilitate interaction with natural earth map data\n\n## Useful openwashdata datasets\n\n-   `gdho`: Global database of humanitarian organizations from Humanitarian Outcomes.\n\n# Plot a thematic map with external geodata\n\nIn this demo, we will show you how to plot a map to reflect the headquarter concentration of the humanitarian headquarters around the world. At the end of the demo, you will learn how to:\n\n-   Summarize headquarter information from `gdho` data\n-   Combine `gdho` data with external geolocation data\n-   Visualize a thematic map about headquarter location distribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load libraries\nlibrary(gdho)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(sf) # for geolocation \nlibrary(rnaturalearth) # for geolocation \nlibrary(viridis)  \nlibrary(kableExtra) # for nice table display\n```\n:::\n\n\n## 1. Data processing: summarize headquarters {#sec-data-processing}\n\nThe data `gdho` contains the headquarter information of each humanitarian organization in the variable `hq_location`. First, we look at how many headquarters each country has. We process the column `hq_location` and display the top countries:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngdho_hq <- gdho |>\n  filter(!is.na(hq_location)) |> # remove NA data \n  group_by(hq_location) |> # group by countries\n  summarise(count = n()) |> # count the number of headquarters of each country\n  arrange(desc(count)) # sort by descending order\n  \ngdho_hq |>\n  head() |>\n  kbl()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> hq_location </th>\n   <th style=\"text-align:right;\"> count </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:right;\"> 324 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Somalia </td>\n   <td style=\"text-align:right;\"> 266 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Afghanistan </td>\n   <td style=\"text-align:right;\"> 241 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Pakistan </td>\n   <td style=\"text-align:right;\"> 177 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Colombia </td>\n   <td style=\"text-align:right;\"> 169 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Ukraine </td>\n   <td style=\"text-align:right;\"> 165 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nWe can see that the top six countries having the most humanitarian organization headquarters are United States, Somalia, Afgahnistan, Pakistan, Colombia and Ukraine.\n\n## 2. Data combination: join with geodata\n\nNow, we need to acquire geographical information of the countries (e.g. the borders). Here we use the package `rnaturalearth` and `sf` to help. The package `rnaturalearth` contains geodata about the countries in the world, and we import this dataset and combine it with our `gdho` data on the column `hq_location`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nworld <- rnaturalearth::ne_countries(returnclass = \"sf\")\n\nhq_map_data <- left_join(world, gdho_hq, by = c(\"name_long\" = \"hq_location\"))\n```\n:::\n\n\n## 3. Map visualization: concentration of the headquarters\n\nWe have the data that contains all information we need: the counts of humanitarian organization headquarters each country has, and the geo-information of each country. We start by plotting the world view of the headquarter concentration.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhq_map <- ggplot() +\n  theme_void() +\n  geom_sf(data = hq_map_data, aes(fill = count), color = \"white\", lwd = 0)  # plot map\nhq_map\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/world_map-1.png){width=672}\n:::\n:::\n\n\nHooray! We got a map that reflects about the humanitarian headquarter concentration globally. The lighter blue indicates a larger number of headquarters, where we can see some countries like U.S. and Ukraine are on this side. That is matching our findings in @sec-data-processing.\n\nBut this map is somehow hart to read and lack of description to stand alone. We will polish the map by grouping the countries into several groups depending on their headquarter numbers and add more explanations.\n\n### 3.1 Rescale the data\nTo better visualize the concentration, we rescale the data and set up groups for the number of headquarters, i.e. countries having 1-10 headquarters, having 10-50 headquarters and etc.. A useful trick is to transform the data via a log transformation so the color will be set up more distinguishable. We use `scale_fill_viridis` to achieve this as the following:\n\n::: {.cell}\n\n```{.r .cell-code}\nhq_map <- hq_map +\n    scale_fill_viridis(trans = \"log\", breaks=c(1,10,50,100,300), \n                       # Legend style\n                       name = \"Num. Headquarters\",\n                       guide = guide_legend(\n                           keyheight = unit (2, units = \"mm\"),\n                           label.position = \"bottom\", \n                           title.position = 'top', nrow = 1))\nhq_map\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/hq_map_rescale-1.png){width=672}\n:::\n:::\n\n\nFor comparison, if we do not apply the log transformation `trans = \"log\"`, it will look the following:\n\n::: {.cell}\n\n```{.r .cell-code}\nhq_map +\n    scale_fill_viridis(breaks=c(1,10,50,100,300))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/hq_map_noscale-1.png){width=672}\n:::\n:::\n\n\n### 3.2 Provide clear description\nWe add title and caption to explain the figure.\n\n::: {.cell}\n\n```{.r .cell-code}\nhq_map <- hq_map +\n    labs(\n    title = \"Humanitarian Organization Headquarters Concentration\",\n    subtitle = \"Number of headquarters per country\"\n  )  # add metadata\nhq_map\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/hq_map_description-1.png){width=672}\n:::\n:::\n\n\n### 3.3 Format the theme\nAlmost done! The final polish is to make it more visually appealing. For instance, we do not have headquarters on Antarctic, so removing it from the map is good to reduce unnecessary information. We further provide a grey background and reposition the legend.\n\n::: {.cell}\n\n```{.r .cell-code}\nhq_map <- hq_map +\n  theme(\n    plot.background = element_rect(fill = \"#f5f5f2\", color = NA),\n    legend.position = c(0.13, 0.15)\n  ) + # polish the appearance\n  coord_sf(ylim = c(-50, 90)) # Remove antarctic\nhq_map\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/hq_map_theme-1.png){width=672}\n:::\n:::\n\n\n# Read more\n- [Part 1: Plot basic map with collected data](https://openwashdata.org/pages/blog/posts/2024-03-01-create-map-part-1/#plot-map-with-collected-data)\n- Part 3: Make an interactive map\n\nReferences:\n\n\\[1\\] [Choropleth map with R and ggplot2](https://r-graph-gallery.com/327-chloropleth-map-from-geojson-with-ggplot2.html)\n\\[2\\] [gdho Example Tutorial: Where are the headquarters of humanitarian organizations?](https://openwashdata.github.io/gdho/articles/examples.html)",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}