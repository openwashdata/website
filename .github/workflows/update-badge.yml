name: Update Analytics Badge

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  workflow_dispatch:  # Allow manual triggering with inputs
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: false
        type: boolean
      custom_message:
        description: 'Custom commit message (optional)'
        required: false
        type: string
  push:  # Trigger on push to any branch
    branches: ['**']

jobs:
  update-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to commit changes
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Fetch Plausible Analytics Data
        id: analytics
        run: |
          echo "=== DEBUG INFORMATION ==="
          echo "Checking if API key is set..."
          if [ -z "${{ secrets.PLAUSIBLE_API_KEY }}" ]; then
            echo "❌ PLAUSIBLE_API_KEY is not set in repository secrets!"
            echo "Using fallback values..."
            pageviews="Loading..."
            visitors="Loading..."
            formatted_pageviews="Loading..."
            formatted_visitors="Loading..."
          else
            echo "✅ PLAUSIBLE_API_KEY is set"
            
            # Fetch both pageviews and visitors from Plausible API
            response=$(curl -s -X POST https://plausible.io/api/v2/query \
              -H "Authorization: Bearer ${{ secrets.PLAUSIBLE_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d '{
                "site_id": "openwashdata.org",
                "metrics": ["pageviews", "visitors"],
                "date_range": "all"
              }')
            
            echo "API Response: $response"
            
            # Check if response contains error
            if echo "$response" | jq -e '.error' > /dev/null 2>&1; then
              echo "API Error: $(echo "$response" | jq -r '.error')"
              pageviews="Error"
              visitors="Error"
              formatted_pageviews="Error"
              formatted_visitors="Error"
            else
              # Extract pageview and visitor counts
              pageviews=$(echo $response | jq -r '.results[0].pageviews // 0')
              visitors=$(echo $response | jq -r '.results[0].visitors // 0')
              
              echo "Extracted pageviews: $pageviews"
              echo "Extracted visitors: $visitors"
              
              # Format numbers with commas for readability
              if [ "$pageviews" != "0" ] && [ "$pageviews" != "null" ]; then
                formatted_pageviews=$(echo $pageviews | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
              else
                formatted_pageviews="Loading..."
              fi
              
              if [ "$visitors" != "0" ] && [ "$visitors" != "null" ]; then
                formatted_visitors=$(echo $visitors | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
              else
                formatted_visitors="Loading..."
              fi
            fi
          fi
          
          echo "Final values - Pageviews: $formatted_pageviews, Visitors: $formatted_visitors"
          
          echo "pageviews=$pageviews" >> $GITHUB_OUTPUT
          echo "formatted_pageviews=$formatted_pageviews" >> $GITHUB_OUTPUT
          echo "visitors=$visitors" >> $GITHUB_OUTPUT
          echo "formatted_visitors=$formatted_visitors" >> $GITHUB_OUTPUT
          
      - name: Create Badge Data
        run: |
          echo "Creating badge files..."
          
          # Get values from previous step
          pageviews_value="${{ steps.analytics.outputs.formatted_pageviews }}"
          visitors_value="${{ steps.analytics.outputs.formatted_visitors }}"
          
          echo "Using pageviews: $pageviews_value"
          echo "Using visitors: $visitors_value"
          
          # Create pageviews badge data JSON file (dark purple)
          cat > badge-data-pageviews.json << EOF
          {
            "schemaVersion": 1,
            "label": "Total Views",
            "message": "$pageviews_value",
            "color": "2d0e2d",
            "cacheSeconds": 86400
          }
          EOF
          
          # Create unique visitors badge data JSON file (light purple)
          cat > badge-data-visitors.json << EOF
          {
            "schemaVersion": 1,
            "label": "Unique Visitors",
            "message": "$visitors_value",
            "color": "c8a3c8",
            "cacheSeconds": 86400
          }
          EOF
          
          echo "Badge files created successfully:"
          ls -la badge-data-*.json
          echo "Content of pageviews badge:"
          cat badge-data-pageviews.json
          echo "Content of visitors badge:"
          cat badge-data-visitors.json
          
      - name: Update README Badge
        run: |
          # Update README.md with current timestamp
          if grep -q "Updated:" README.md; then
            sed -i "s/Updated: .*/Updated: $(date +'%Y-%m-%d')/" README.md
          else
            echo "" >> README.md
            echo "*Updated: $(date +'%Y-%m-%d')*" >> README.md
          fi
          
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add badge-data-pageviews.json badge-data-visitors.json README.md
          
          # Use custom commit message if provided, otherwise use default
          if [ -n "${{ github.event.inputs.custom_message }}" ]; then
            commit_msg="${{ github.event.inputs.custom_message }}"
          else
            commit_msg="Update analytics badges: ${{ steps.analytics.outputs.formatted_pageviews }} views, ${{ steps.analytics.outputs.formatted_visitors }} visitors"
          fi
          
          # Force commit if requested, otherwise only commit if changes exist
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            git commit -m "$commit_msg" --allow-empty
          else
            git diff --staged --quiet || git commit -m "$commit_msg"
          fi
          
          git push